<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game Scout ‚Äî Dashboard</title>
  <style>
    :root{
      --bg: #0b0f14;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --blue: #6ea8ff;
      --green: #79e29b;
      --orange: #ffb86b;
      --red: #ff6b81;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% 0%, rgba(110,168,255,0.25), transparent 60%),
                  radial-gradient(1000px 700px at 80% 10%, rgba(121,226,155,0.18), transparent 55%),
                  radial-gradient(900px 700px at 50% 100%, rgba(255,184,107,0.10), transparent 60%),
                  var(--bg);
      color: var(--text);
    }
    .wrap{ max-width: 1200px; margin: 28px auto 60px; padding: 0 18px; }
    .hero{
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
      border: 1px solid var(--stroke);
      border-radius: 22px;
      padding: 26px 26px 22px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
      backdrop-filter: blur(12px);
    }
    .title{
      display:flex; align-items:center; gap:14px;
      font-size: 56px; line-height:1; font-weight: 800;
      color: var(--blue);
      margin: 0;
    }
    .sub{
      margin: 10px 0 0;
      color: var(--muted);
      font-size: 18px;
    }
    .tabs{
      margin-top: 18px;
      display:flex; gap: 12px;
      padding: 14px;
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      backdrop-filter: blur(10px);
      overflow:auto;
    }
    .tab{
      white-space: nowrap;
      cursor:pointer;
      padding: 10px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      color: var(--muted);
      transition: 120ms ease;
      user-select:none;
      font-weight: 650;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(110,168,255,0.35);
      background: rgba(110,168,255,0.18);
      box-shadow: 0 10px 28px rgba(0,0,0,0.35);
    }
    .panel{
      margin-top: 18px;
      padding: 18px;
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: 22px;
      backdrop-filter: blur(12px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    .panel h2{ margin: 2px 0 14px; font-size: 26px; }
    .status{
      margin-top: 10px;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.18);
      color: var(--muted);
    }

    /* Relaunch */
    .cards{ display:grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 14px; }
    @media (max-width: 980px){ .cards{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 560px){ .cards{ grid-template-columns: 1fr;} }
    .kpi{
      padding: 16px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.18);
    }
    .kpi .label{ color: var(--muted); font-weight: 650; }
    .kpi .val{ margin-top: 6px; font-size: 38px; font-weight: 800; }
    .val.green{ color: var(--green); }
    .val.orange{ color: var(--orange); }
    .val.red{ color: var(--red); }

    .row{
      display:flex; gap: 10px; flex-wrap: wrap;
      margin-top: 14px;
      padding: 14px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.18);
    }
    .row input{
      flex: 1 1 260px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      outline: none;
    }
    .btn{
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.10);
      color: var(--text);
      font-weight: 750;
      cursor:pointer;
      user-select:none;
    }
    .btn.primary{
      border-color: rgba(110,168,255,0.35);
      background: rgba(110,168,255,0.20);
    }
    .small{
      color: var(--muted);
      font-size: 13px;
      margin-top: 8px;
    }

    .filter{
      display:flex; gap: 10px; margin-top: 12px;
    }
    .chip{
      cursor:pointer;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: var(--muted);
      font-weight: 700;
    }
    .chip.active{
      color: var(--text);
      border-color: rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.10);
    }

    .list{ margin-top: 14px; display:flex; flex-direction: column; gap: 12px; }
    .item{
      display:flex; justify-content: space-between; gap: 14px;
      padding: 16px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.18);
    }
    .item .left{ min-width: 0; }
    .item .name{ font-size: 22px; font-weight: 850; margin: 0; }
    .item .meta{ margin-top: 4px; color: var(--muted); font-weight: 650; }
    .item .reason{ margin-top: 10px; color: rgba(255,255,255,0.82); }
    .score{
      min-width: 82px;
      height: 48px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 14px;
      border: 1px solid rgba(255,107,129,0.35);
      background: rgba(255,107,129,0.10);
      font-size: 24px;
      font-weight: 900;
      color: var(--red);
    }
    .score.good{
      border-color: rgba(121,226,155,0.35);
      background: rgba(121,226,155,0.12);
      color: var(--green);
    }
    .score.mid{
      border-color: rgba(255,184,107,0.35);
      background: rgba(255,184,107,0.12);
      color: var(--orange);
    }

    .hidden{ display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1 class="title">ü´ê Game Scout</h1>
      <div class="sub">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç—Ä–µ–Ω–¥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="analytics">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
      <div class="tab" data-tab="youtube">üì∫ YouTube</div>
      <div class="tab" data-tab="reddit">üü† Reddit</div>
      <div class="tab" data-tab="games">üéÆ –ë–∞–∑–∞ –∏–≥—Ä</div>
      <div class="tab" data-tab="relaunch">üöÄ Relaunch Scout</div>
      <div class="tab" data-tab="yearly">üìÖ –ì–æ–¥–æ–≤–æ–π –æ–±–∑–æ—Ä</div>
    </div>

    <!-- Analytics -->
    <section class="panel" id="panel-analytics">
      <h2>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
      <div class="status" id="analytics-status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </section>

    <!-- YouTube -->
    <section class="panel hidden" id="panel-youtube">
      <h2>üì∫ YouTube</h2>
      <div class="status" id="youtube-status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </section>

    <!-- Reddit -->
    <section class="panel hidden" id="panel-reddit">
      <h2>üü† Reddit</h2>
      <div class="status" id="reddit-status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </section>

    <!-- Games -->
    <section class="panel hidden" id="panel-games">
      <h2>üéÆ –ë–∞–∑–∞ –∏–≥—Ä</h2>
      <div class="status" id="games-status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      <div class="status" id="games-list" style="margin-top:12px; display:none;"></div>
    </section>

    <!-- Relaunch -->
    <section class="panel hidden" id="panel-relaunch">
      <h2>üöÄ Relaunch Scout</h2>

      <div class="cards">
        <div class="kpi">
          <div class="label">Tracked apps</div>
          <div class="val" id="relaunch-tracked">-</div>
        </div>
        <div class="kpi">
          <div class="label">Candidates (all)</div>
          <div class="val green" id="relaunch-candidates">-</div>
        </div>
        <div class="kpi">
          <div class="label">Watchlist</div>
          <div class="val orange" id="relaunch-watchlist">-</div>
        </div>
        <div class="kpi">
          <div class="label">Rejected</div>
          <div class="val" id="relaunch-rejected">-</div>
        </div>
      </div>

      <div class="row">
        <input id="relaunch-app-id" placeholder="Steam App ID (–Ω–∞–ø—Ä–∏–º–µ—Ä 1091500)" />
        <input id="relaunch-app-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã (–∫–∞–∫ —Ö–æ—á–µ—à—å –≤–∏–¥–µ—Ç—å)" />
        <button class="btn primary" id="btn-track">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="btn" id="btn-refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
        < <div class="small">
          API: <code>/api/v1/relaunch/health</code>, <code>/api/v1/relaunch/candidates</code>, <code>/api/v1/relaunch/admin/track</code>, <code>/api/v1/relaunch/admin/bulk_track</code>
        </div>
      </div>

      <div class="filter">
        <div class="chip active" data-filter="all">–í—Å–µ</div>
        <div class="chip" data-filter="watchlist">Watchlist</div>
        <div class="chip" data-filter="rejected">Rejected</div>
      </div>

      <div class="list" id="relaunch-cards"></div>
      <div class="status" id="relaunch-error" style="display:none; border-color: rgba(255,107,129,0.35); color: rgba(255,255,255,0.85);">
        –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
      </div>
    </section>

    <!-- Yearly -->
    <section class="panel hidden" id="panel-yearly">
      <h2>üìÖ –ì–æ–¥–æ–≤–æ–π –æ–±–∑–æ—Ä</h2>
      <div class="status" id="yearly-status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </section>
  </div>

<script>
  const API = "/api/v1";

  function qs(sel){ return document.querySelector(sel); }
  function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }

  function switchTab(tab){
    qsa(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === tab));
    qsa("section.panel").forEach(p => p.classList.add("hidden"));
    qs(`#panel-${tab}`).classList.remove("hidden");

    // lazy load per tab
    if(tab === "analytics") loadAnalytics();
    if(tab === "youtube") loadYouTube();
    if(tab === "reddit") loadReddit();
    if(tab === "games") loadGames();
    if(tab === "relaunch") loadRelaunch();
    if(tab === "yearly") loadYearly();
  }

  qsa(".tab").forEach(t => t.addEventListener("click", () => switchTab(t.dataset.tab)));

  // --------------------------
  // Generic fetch helper
  // --------------------------
  async function jget(url){
    const res = await fetch(url, {headers: {"accept":"application/json"}});
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    return await res.json();
  }

  // --------------------------
  // Analytics
  // --------------------------
  async function loadAnalytics(){
    const el = qs("#analytics-status");
    try{
      const health = await jget(`${API}/analytics/health`);
      const sum = await jget(`${API}/analytics/summary`);
      el.textContent = `OK: ${health.status}. Relaunch tracked: ${sum.relaunch_tracked}`;
    }catch(e){
      el.textContent = `Backend not ready: ${e.message}`;
    }
  }

  // --------------------------
  // YouTube
  // --------------------------
  async function loadYouTube(){
    const el = qs("#youtube-status");
    try{
      const health = await jget(`${API}/youtube/health`);
      const sum = await jget(`${API}/youtube/summary`);
      el.textContent = `OK: ${health.status}. Items: ${sum.items.length}`;
    }catch(e){
      el.textContent = `Backend not ready: ${e.message}`;
    }
  }

  // --------------------------
  // Reddit
  // --------------------------
  async function loadReddit(){
    const el = qs("#reddit-status");
    try{
      const health = await jget(`${API}/reddit/health`);
      const sum = await jget(`${API}/reddit/summary`);
      el.textContent = `OK: ${health.status}. Items: ${sum.items.length}`;
    }catch(e){
      el.textContent = `Backend not ready: ${e.message}`;
    }
  }

  // --------------------------
  // Games
  // --------------------------
  async function loadGames(){
    const st = qs("#games-status");
    const list = qs("#games-list");
    try{
      const health = await jget(`${API}/games/health`);
      const rows = await jget(`${API}/games/list?limit=50`);
      st.textContent = `OK: ${health.status}. Rows: ${rows.length}`;
      if(rows.length){
        list.style.display = "block";
        list.innerHTML = rows.map(r => `<div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.06)">
          <b>${r.name ?? "‚Äî"}</b> <span style="color:rgba(255,255,255,0.6)">#${r.steam_app_id}</span>
          <span style="float:right;color:rgba(255,255,255,0.6)">reviews: ${r.review_count}</span>
        </div>`).join("");
      }else{
        list.style.display = "block";
        list.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä (—Ç–∞–±–ª–∏—Ü–∞ steam_games/games –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –ø—É—Å—Ç–∞).";
      }
    }catch(e){
      st.textContent = `Backend not ready: ${e.message}`;
      list.style.display = "none";
    }
  }

  // --------------------------
  // Yearly
  // --------------------------
  async function loadYearly(){
    const el = qs("#yearly-status");
    try{
      const health = await jget(`${API}/yearly/health`);
      const sum = await jget(`${API}/yearly/summary`);
      el.textContent = `OK: ${health.status}. ${sum.note ?? ""}`;
    }catch(e){
      el.textContent = `Backend not ready: ${e.message}`;
    }
  }

  // --------------------------
  // Relaunch
  // --------------------------
  let relaunchAll = [];
  let relaunchFilter = "all";

  function classifyCounts(items){
    const c = {candidate:0, watchlist:0, rejected:0};
    for(const it of items){
      if(it.classification === "watchlist") c.watchlist++;
      else if(it.classification === "rejected") c.rejected++;
      else c.candidate++;
    }
    return c;
  }

  function scoreClass(v){
    if(v >= 70) return "good";
    if(v >= 40) return "mid";
    return "";
  }

  function renderRelaunch(items){
    const box = qs("#relaunch-cards");
    if(!box) return;

    const show = (relaunchFilter === "all")
      ? items
      : items.filter(x => x.classification === relaunchFilter);

    if(!show.length){
      box.innerHTML = `<div class="status">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞: <b>${relaunchFilter}</b></div>`;
      return;
    }

    box.innerHTML = show.map(app => {
      const score = Number(app.relaunch_score || 0);
      const cls = scoreClass(score);
      const ss = app.latest_snapshot;
      const snap = ss ? `‚Ä¢ snapshot: ${ss.captured_at} ‚Ä¢ price: ${ss.price_eur ?? "‚Äî"}‚Ç¨ ‚Ä¢ reviews: ${ss.all_reviews_count} (recent ${ss.recent_reviews_count})` : "";
      const meta = `classification: <b>${app.classification ?? "‚Äî"}</b> ‚Ä¢ computed_at: ${app.computed_at ?? "‚Äî"} ${snap}`;
      return `
        <div class="item">
          <div class="left">
            <div class="name">${app.name} <span style="color:rgba(255,255,255,0.6)">(#${app.steam_app_id})</span></div>
            <div class="meta">${meta}</div>
            <div class="reason">${(app.reasoning || "").replaceAll("<","&lt;")}</div>
          </div>
          <div class="score ${cls}">${score.toFixed(1)}</div>
        </div>
      `;
    }).join("");
  }

  async function loadRelaunch(){
    const err = qs("#relaunch-error");
    err.style.display = "none";
    try{
      const health = await jget(`${API}/relaunch/health`);
      qs("#relaunch-tracked").textContent = health.tracked_apps ?? 0;

      const items = await jget(`${API}/relaunch/candidates?min_score=0&limit=200`);
      relaunchAll = items;

      const c = classifyCounts(items);
      qs("#relaunch-candidates").textContent = items.length;
      qs("#relaunch-watchlist").textContent = c.watchlist;
      qs("#relaunch-rejected").textContent = c.rejected;

      renderRelaunch(items);
    }catch(e){
      err.style.display = "block";
      err.textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ relaunch: ${e.message}`;
    }
  }

  // Track new app
  qs("#btn-track").addEventListener("click", async () => {
    const sid = qs("#relaunch-app-id").value.trim();
    const name = qs("#relaunch-app-name").value.trim();

    if(!sid || !name){
      alert("–ù—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å Steam App ID –∏ –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã");
      return;
    }

    try{
      const res = await fetch(`${API}/relaunch/admin/track`, {
        method: "POST",
        headers: {"content-type":"application/json"},
        body: JSON.stringify({steam_app_id: Number(sid), name: name, tracking_priority: 50})
      });
      const data = await res.json();
      if(!res.ok) throw new Error(JSON.stringify(data));
      qs("#relaunch-app-id").value = "";
      qs("#relaunch-app-name").value = "";
      await loadRelaunch();
    }catch(e){
      alert("–û—à–∏–±–∫–∞ track: " + e.message);
    }
  });

  qs("#btn-refresh").addEventListener("click", loadRelaunch);

  // Filter chips
  qsa(".chip").forEach(ch => {
    ch.addEventListener("click", () => {
      qsa(".chip").forEach(x => x.classList.remove("active"));
      ch.classList.add("active");
      relaunchFilter = ch.dataset.filter;
      renderRelaunch(relaunchAll);
    });
  });

  // initial load
  loadAnalytics();
</script>
</body>
</html>